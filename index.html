<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duck√©mon: Chronos Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { 
            --grass: #78C850; --forest: #45a049; --sand: #F0D060; --water: #6890F0;
            --hp-green: #2ecc71; --hp-red: #e74c3c;
        }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Press Start 2P', cursive; overflow: hidden; }

        /* --- THE WORLD & DAY/NIGHT --- */
        #viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; transition: filter 5s ease; }
        .day { filter: brightness(1); }
        .night { filter: brightness(0.5) contrast(1.2) hue-rotate(-20deg); }
        
        #world { position: absolute; transition: transform 0.2s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        .tile { width: 64px; height: 64px; position: absolute; image-rendering: pixelated; }
        .t-grass { background: var(--grass); border: 1px solid rgba(0,0,0,0.02); }
        .t-forest { background: var(--forest); background-image: radial-gradient(#2D5A27 15%, transparent 15%); background-size: 8px 8px; }
        .t-sand { background: var(--sand); }
        .t-water { background: var(--water); border: 2px solid rgba(255,255,255,0.1); }

        /* --- STABILIZED SPRITES --- */
        .pixel-art {
            width: 4px; height: 4px; background: transparent;
            box-shadow: 8px 4px 0 #000, 12px 4px 0 #000, 16px 4px 0 #000, 4px 8px 0 #000, 8px 8px 0 var(--c), 12px 8px 0 var(--c), 16px 8px 0 var(--c), 20px 8px 0 #000, 4px 12px 0 #000, 8px 12px 0 var(--c), 12px 12px 0 var(--c), 16px 12px 0 var(--c), 20px 12px 0 #e67e22, 8px 16px 0 #000, 12px 16px 0 #000, 16px 16px 0 #000;
            transform: scale(3.5); position: absolute; transition: transform 0.1s, top 0.2s, left 0.2s; will-change: transform;
        }
        .evolved { transform: scale(5); filter: drop-shadow(0 0 10px var(--c)); }
        .tall-grass-clip { clip-path: inset(0% 0% 40% 0%); }
        #player-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1000; }

        /* --- CLEAN UI --- */
        .screen { position: absolute; inset: 0; z-index: 3000; display: none; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #hud { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 15px; z-index: 1500; pointer-events: none; }
        .hud-item { background: #fff; border: 3px solid #000; padding: 10px; font-size: 9px; pointer-events: auto; }
        #chat-box { position: absolute; bottom: 100px; left: 15px; width: 260px; height: 130px; background: rgba(0,0,0,0.7); border: 2px solid #fff; z-index: 2000; padding: 10px; color: #fff; font-size: 7px; pointer-events: none; overflow: hidden; border-radius: 5px; }

        /* --- REFINED BATTLE UI --- */
        #battle-screen { background: linear-gradient(#98D8D8, #fff); }
        .hp-outer { width: 140px; height: 10px; background: #333; border: 2px solid #000; }
        .hp-inner { height: 100%; background: var(--hp-green); transition: width 0.4s; }
        .btn { font-family: 'Press Start 2P'; padding: 12px; border: 4px solid #000; background: #fff; cursor: pointer; font-size: 8px; }
        .btn:active { background: #ddd; transform: translateY(2px); }
    </style>
</head>
<body onload="init()">

<div id="viewport" class="day">
    <div id="world"></div>
    <div id="player-container"><div id="p-sprite" class="pixel-art" style="--c:#f1c40f"></div></div>

    <div id="hud">
        <div class="hud-item">ü•ñ: <span id="bread">100</span> | <span id="time-text">DAY</span></div>
        <div class="hud-item" onclick="toggleScreen('inv-screen')">POKEDUCK</div>
        <div class="hud-item">üéñÔ∏è: <span id="badges">0</span></div>
    </div>

    <div id="chat-box" id="chat-log"></div>

    <div id="inv-screen" class="screen">
        <div style="background:#fff; padding:25px; border:6px double #000; width:90%; max-height:80%; overflow-y:auto; text-align:center;">
            <h2 style="font-size:12px;">INVENTORY</h2>
            <p style="font-size:7px; margin-bottom:15px;">STONES - F:<span id="s-fire">0</span> W:<span id="s-water">0</span> L:<span id="s-leaf">0</span></p>
            <div id="inventory-slots" style="display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin-bottom:20px;"></div>
            <button class="btn" style="width:100%" onclick="toggleScreen('inv-screen')">CLOSE</button>
        </div>
    </div>

    <div id="battle-screen" class="screen">
        <div style="flex:1; width:100%; display:flex; justify-content:space-around; align-items:center;">
            <div style="text-align:center;">
                <div class="hp-outer"><div id="e-hp-fill" class="hp-inner"></div></div>
                <div id="e-sprite-battle" class="pixel-art" style="position:relative; transform:scale(7); margin-top:50px;"></div>
            </div>
            <div style="text-align:center;">
                <div id="p-sprite-battle" class="pixel-art" style="position:relative; transform:scale(7); margin-bottom:30px;"></div>
                <div class="hp-outer"><div id="p-hp-fill" class="hp-inner"></div></div>
            </div>
        </div>
        <div style="height:150px; width:100%; background:#fff; border-top:8px solid #333; display:grid; grid-template-columns:1fr 1fr; gap:15px; padding:20px;">
            <button class="btn" onclick="playerAttack()">TACKLE</button>
            <button class="btn" onclick="playerCatch()">CATCH</button>
        </div>
    </div>
</div>

<script>
    const DUCK_TYPES = [
        { name: "Pebble", color: "#95a5a6", biome: "t-grass", stone: "leaf", time: "day" },
        { name: "Inferno", color: "#e74c3c", biome: "t-forest", stone: "fire", time: "day" },
        { name: "Tidal", color: "#3498db", biome: "t-water", stone: "water", time: "any" },
        { name: "Luna", color: "#1abc9c", biome: "t-forest", stone: "water", time: "night" },
        { name: "Shadow", color: "#2c3e50", biome: "t-grass", stone: "fire", time: "night" },
        { name: "Cosmic", color: "#f1c40f", biome: "any", stone: "leaf", time: "any" }
    ];

    let p = { x: 0, y: 0, bread: 100, inv: [], hp: 100, maxHp: 100, badges: 0, stones: {fire:0, water:0, leaf:0} };
    let enemy = null, turn = 'player', rendered = {}, isDay = true;

    function init() {
        renderWorld(); setupInventory();
        setInterval(toggleTime, 30000); // 30 seconds for testing cycle
        setInterval(spawnBotChat, 6000);
        window.addEventListener('keydown', e => {
            if(document.getElementById('battle-screen').style.display==='flex') return;
            let mx=0, my=0;
            const k = e.key.toLowerCase();
            if(k==='w'||k==='arrowup') my=64; if(k==='s'||k==='arrowdown') my=-64;
            if(k==='a'||k==='arrowleft') mx=-64; if(k==='d'||k==='arrowright') mx=64;
            if(mx!==0 || my!==0) move(mx, my);
        });
    }

    function toggleTime() {
        isDay = !isDay;
        document.getElementById('viewport').className = isDay ? 'day' : 'night';
        document.getElementById('time-text').innerText = isDay ? 'DAY' : 'NIGHT';
        addChat("SYSTEM", `The sun has ${isDay ? 'risen' : 'set'}...`);
    }

    function move(mx, my) {
        p.x += mx; p.y += my;
        document.getElementById('p-sprite').style.transform = `scale(3.5) scaleX(${mx < 0 ? -1 : 1})`;
        renderWorld();
        
        let tx = Math.floor(p.x/64), ty = Math.floor(p.y/64);
        let t = getTerrain(tx, ty);
        document.getElementById('p-sprite').className = (t==='t-forest' ? 'pixel-art tall-grass-clip' : 'pixel-art');

        if(Math.random() < 0.05) {
            let sType = t==='t-forest'?'fire':(t==='t-water'?'water':'leaf');
            p.stones[sType]++; addChat("ITEM", `Found a ${sType.toUpperCase()} STONE!`);
            updateStoneUI();
        }
        if(t==='t-forest' && Math.random() < 0.15) startBattle(t);
    }

    function startBattle(biome) {
        let timeTag = isDay ? 'day' : 'night';
        let pool = DUCK_TYPES.filter(d => (d.biome === biome || d.biome === 'any') && (d.time === timeTag || d.time === 'any'));
        let template = pool[Math.floor(Math.random()*pool.length)];
        let isBoss = Math.random() < 0.1;
        
        enemy = { ...template, hp: isBoss?180:100, max: isBoss?180:100, isBoss };
        p.hp = p.maxHp; turn = 'player';
        
        document.getElementById('battle-screen').style.display = 'flex';
        document.getElementById('e-sprite-battle').style.setProperty('--c', enemy.color);
        if(isBoss) document.getElementById('e-sprite-battle').classList.add('evolved');
        else document.getElementById('e-sprite-battle').classList.remove('evolved');
        updateBars();
    }

    function playerAttack() {
        if(turn !== 'player') return;
        enemy.hp -= 35; updateBars();
        if(enemy.hp <= 0) { win(); } 
        else { turn = 'enemy'; setTimeout(enemyTurn, 600); }
    }

    function enemyTurn() {
        p.hp -= enemy.isBoss?25:15; updateBars();
        if(p.hp <= 0) { alert("Whited out!"); endBattle(); } 
        else turn = 'player';
    }

    function win() {
        p.bread += enemy.isBoss?150:50;
        if(enemy.isBoss) { p.badges++; p.maxHp += 20; }
        if(p.inv.length > 0) {
            p.inv[0].wins = (p.inv[0].wins || 0) + 1;
            if(p.inv[0].wins >= 3) evolve(0);
        }
        endBattle();
    }

    function playerCatch() {
        if(enemy.hp < (enemy.max * 0.7) && Math.random() > 0.4) {
            p.inv.push({...enemy, wins:0, isEvo:false}); setupInventory(); endBattle();
        } else { addChat("SYSTEM", "Escaped!"); turn = 'enemy'; setTimeout(enemyTurn, 600); }
    }

    function evolve(idx) {
        let d = p.inv[idx];
        if(!d.isEvo) {
            d.name = "ALPHA " + d.name; d.isEvo = true;
            setupInventory();
        }
    }

    function useStone(idx, type) {
        if(p.stones[type] > 0 && p.inv[idx].stone === type) {
            p.stones[type]--; evolve(idx); updateStoneUI();
        }
    }

    function renderWorld() {
        const w = document.getElementById('world');
        const cx = Math.floor(p.x/64), cy = Math.floor(p.y/64);
        for(let i=-8; i<=8; i++) {
            for(let j=-8; j<=8; j++) {
                let tx = cx+i, ty = cy+j;
                if(!rendered[`${tx},${ty}`]) {
                    const div = document.createElement('div');
                    div.className = `tile ${getTerrain(tx, ty)}`;
                    div.style.left = tx*64+'px'; div.style.top = -ty*64+'px';
                    w.appendChild(div); rendered[`${tx},${ty}`] = true;
                }
            }
        }
        w.style.transform = `translate(${-p.x + window.innerWidth/2}px, ${p.y + window.innerHeight/2}px)`;
    }

    function getTerrain(
