<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duck√©mon: Emerald Horizon</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { 
            --grass: #78C850; --forest: #45a049; --sand: #F0D060; --water: #6890F0;
            --sky-day: #87CEEB; --sky-night: #2c3e50;
        }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Press Start 2P', cursive; overflow: hidden; background: #000; }

        /* --- THE FIXED BACKGROUND --- */
        #viewport { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; 
            transition: background 3s ease;
            background: var(--sky-day); /* Default Day Sky */
        }
        #viewport.night { background: var(--sky-night); }

        #world { position: absolute; transition: transform 0.15s linear; z-index: 5; }
        .tile { width: 64px; height: 64px; position: absolute; image-rendering: pixelated; border: 0.5px solid rgba(0,0,0,0.05); }
        .t-grass { background: var(--grass); }
        .t-forest { background: var(--forest); background-image: radial-gradient(#2D5A27 15%, transparent 15%); background-size: 8px 8px; }
        .t-sand { background: var(--sand); }
        .t-water { background: var(--water); box-shadow: inset 0 0 10px rgba(255,255,255,0.2); }

        /* --- SPRITES --- */
        .pixel-art {
            width: 4px; height: 4px; background: transparent;
            box-shadow: 8px 4px 0 #000, 12px 4px 0 #000, 16px 4px 0 #000, 4px 8px 0 #000, 8px 8px 0 var(--c), 12px 8px 0 var(--c), 16px 8px 0 var(--c), 20px 8px 0 #000, 4px 12px 0 #000, 8px 12px 0 var(--c), 12px 12px 0 var(--c), 16px 12px 0 var(--c), 20px 12px 0 #e67e22, 8px 16px 0 #000, 12px 16px 0 #000, 16px 16px 0 #000;
            transform: scale(3.5); position: absolute; transition: 0.1s; z-index: 10;
        }
        .mount-active { transform: scale(4.5) translateY(-5px); }
        .evolved { filter: drop-shadow(0 0 8px var(--c)); }
        #player-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1000; }

        /* --- UI & SHOP --- */
        .screen { position: absolute; inset: 0; z-index: 3000; display: none; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        #hud { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-around; padding: 10px; z-index: 1500; background: rgba(255,255,255,0.8); border-bottom: 4px solid #000; }
        .hud-item { background: #fff; border: 3px solid #000; padding: 8px; font-size: 7px; cursor: pointer; }
        .btn { font-family: 'Press Start 2P'; padding: 10px; border: 3px solid #000; background: #fff; cursor: pointer; font-size: 7px; margin: 5px; }
        
        .shop-grid { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; }
        .shop-item { background: #eee; border: 2px solid #000; padding: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 6px; }
    </style>
</head>
<body onload="init()">

<div id="viewport">
    <div id="world"></div>
    <div id="player-container">
        <div id="m-sprite" class="pixel-art" style="display:none; --c:#fff; z-index: 999; opacity: 0.7;"></div>
        <div id="p-sprite" class="pixel-art" style="--c:#f1c40f"></div>
    </div>

    <div id="hud">
        <div class="hud-item">ü•ñ:<span id="bread">100</span></div>
        <div class="hud-item" onclick="toggleScreen('shop-screen')">SHOP</div>
        <div class="hud-item" onclick="toggleScreen('inv-screen')">BAG</div>
        <div class="hud-item">üéñÔ∏è:<span id="badges">0</span></div>
    </div>

    <div id="shop-screen" class="screen">
        <div style="background:#fff; padding:20px; border:4px solid #000; width:85%;">
            <h3 style="font-size:10px; text-align:center;">DUCK SHOP</h3>
            <div class="shop-grid">
                <div class="shop-item"><span>ULTRA CRUMB (Catch +)</span> <button class="btn" onclick="buy('crumb', 50)">50ü•ñ</button></div>
                <div class="shop-item"><span>LEAF STONE</span> <button class="btn" onclick="buy('leaf', 100)">100ü•ñ</button></div>
                <div class="shop-item"><span>FIRE STONE</span> <button class="btn" onclick="buy('fire', 100)">100ü•ñ</button></div>
                <div class="shop-item"><span>WATER STONE</span> <button class="btn" onclick="buy('water', 100)">100ü•ñ</button></div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="toggleScreen('shop-screen')">EXIT</button>
        </div>
    </div>

    <div id="inv-screen" class="screen">
        <div style="background:#fff; padding:20px; border:4px solid #000; width:90%; max-height:80%; overflow-y:auto;">
            <p style="font-size:7px; text-align:center;">STONES: F:<span id="s-fire">0</span> W:<span id="s-water">0</span> L:<span id="s-leaf">0</span></p>
            <p style="font-size:7px; text-align:center;">ULTRA CRUMBS: <span id="s-crumb">0</span></p>
            <div id="inventory-slots" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:15px 0;"></div>
            <button class="btn" style="width:100%" onclick="toggleScreen('inv-screen')">CLOSE</button>
        </div>
    </div>

    <div id="battle-screen" class="screen" style="background:#98D8D8; flex-direction:column;">
        <div style="flex:1; width:100%; display:flex; justify-content:space-around; align-items:center;">
            <div style="text-align:center;"><div id="e-hp-fill" style="width:100px; height:8px; background:#2ecc71; border:2px solid #000;"></div><div id="e-sprite-battle" class="pixel-art" style="position:relative; transform:scale(6); margin-top:40px;"></div></div>
            <div style="text-align:center;"><div id="p-sprite-battle" class="pixel-art" style="position:relative; transform:scale(6); margin-bottom:40px;"></div><div id="p-hp-fill" style="width:100px; height:8px; background:#2ecc71; border:2px solid #000;"></div></div>
        </div>
        <div style="height:120px; width:100%; background:#fff; border-top:4px solid #000; display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:15px;">
            <button class="btn" onclick="playerAttack()">ATTACK</button>
            <button class="btn" onclick="playerCatch()">CATCH</button>
        </div>
    </div>
</div>

<script>
    const DUCK_TYPES = [
        { name: "Pebble", color: "#95a5a6", biome: "t-grass", stone: "leaf" },
        { name: "Inferno", color: "#e74c3c", biome: "t-forest", stone: "fire" },
        { name: "Tidal", color: "#3498db", biome: "t-water", stone: "water" }
    ];

    let p = { x: 0, y: 0, bread: 100, inv: [], hp: 100, maxHp: 100, badges: 0, stones: {fire:0, water:0, leaf:0}, items: {crumb:0}, mount: null };
    let enemy = null, isDay = true, rendered = {};

    function init() {
        renderWorld(); setupInventory();
        setInterval(() => { isDay = !isDay; document.getElementById('viewport').className = isDay?'':'night'; }, 30000);
        window.addEventListener('keydown', e => {
            if(document.querySelector('.screen[style*="flex"]')) return;
            let step = p.mount ? 128 : 64;
            let mx=0, my=0;
            const k = e.key.toLowerCase();
            if(k==='w'||k==='arrowup') my=step; if(k==='s'||k==='arrowdown') my=-step;
            if(k==='a'||k==='arrowleft') mx=-step; if(k==='d'||k==='arrowright') mx=step;
            if(mx!==0 || my!==0) move(mx, my);
        });
    }

    function move(mx, my) {
        p.x += mx; p.y += my;
        document.getElementById('p-sprite').style.transform = `scale(3.5) scaleX(${mx < 0 ? -1 : 1})`;
        if(p.mount) document.getElementById('m-sprite').style.transform = `scale(4.5) scaleX(${mx < 0 ? -1 : 1}) translateY(5px)`;
        renderWorld();
        let t = getTerrain(Math.floor(p.x/64), Math.floor(p.y/64));
        if(t==='t-forest' && Math.random() < 0.12) startBattle(t);
    }

    function buy(item, cost) {
        if(p.bread >= cost) {
            p.bread -= cost;
            if(p.stones[item] !== undefined) p.stones[item]++;
            else p.items[item]++;
            updateUI();
        } else alert("Not enough Bread!");
    }

    function startBattle(biome) {
        let template = DUCK_TYPES[Math.floor(Math.random()*DUCK_TYPES.length)];
        enemy = { ...template, hp: 100, max: 100 };
        document.getElementById('battle-screen').style.display = 'flex';
        document.getElementById('e-sprite-battle').style.setProperty('--c', enemy.color);
    }

    function playerAttack() { enemy.hp -= 40; updateBars(); if(enemy.hp<=0) { p.bread+=50; endBattle(); } }
    function playerCatch() { 
        let chance = p.items.crumb > 0 ? 0.8 : 0.4;
        if(p.items.crumb > 0) p.items.crumb--;
        if(Math.random() < chance) { p.inv.push({...enemy, wins:0, isEvo:false}); setupInventory(); endBattle(); }
        updateUI();
    }

    function toggleMount(idx) {
        p.mount = (p.mount === p.inv[idx]) ? null : p.inv[idx];
        document.getElementById('m-sprite').style.display = p.mount ? 'block' : 'none';
        if(p.mount) document.getElementById('m-sprite').style.setProperty('--c', p.mount.color);
        toggleScreen('inv-screen');
    }

    function evolve(idx) { p.inv[idx].name = "ALPHA " + p.inv[idx].name; p.inv[idx].isEvo = true; setupInventory(); }
    function useStone(idx, type) { if(p.stones[type]>0 && p.inv[idx].stone===type) { p.stones[type]--; evolve(idx); updateUI(); } }

    function renderWorld() {
        const w = document.getElementById('world');
        const cx = Math.floor(p.x/64), cy = Math.floor(p.y/64);
        for(let i=-10; i<=10; i++) {
            for(let j=-10; j<=10; j++) {
                let tx = cx+i, ty = cy+j;
                if(!rendered[`${tx},${ty}`]) {
                    const div = document.createElement('div');
                    div.className = `tile ${getTerrain(tx, ty)}`;
                    div.style.left = tx*64+'px'; div.style.top = -ty*64+'px';
                    w.appendChild(div); rendered[`${tx},${ty}`] = true;
                }
            }
        }
        w.style.transform = `translate(${-p.x + window.innerWidth/2}px, ${p.y + window.innerHeight/2}px)`;
    }

    function getTerrain(x, y) { let n = Math.abs(Math.sin(x*0.1) + Math.cos(y*0.1)); if(n>1.3) return 't-water'; if(n>1.0) return 't-forest'; if(n<0.3) return 't-sand'; return 't-grass'; }
    function setupInventory() {
        const grid = document.getElementById('inventory-slots'); grid.innerHTML = '';
        p.inv.forEach((d, i) => {
            grid.innerHTML += `<div class="shop-item" style="flex-direction:column;"><div class="pixel-art" style="--c:${d.color}; position:relative; margin:10px auto;"></div><br>${d.name}<br>
            ${d.isEvo ? `<button class="btn" onclick="toggleMount(${i})">MOUNT</button>` : `<button class="btn" onclick="useStone(${i},'${d.stone}')">STONE</button>`}</div>`;
        });
    }
    function updateUI() {
        document.getElementById('bread').innerText = p.bread;
        document.getElementById('s-fire').innerText = p.stones.fire;
        document.getElementById('s-water').innerText = p.stones.water;
        document.getElementById('s-leaf').innerText = p.stones.leaf;
        document.getElementById('s-crumb').innerText = p.items.crumb;
    }
    function updateBars() { document.getElementById('e-hp-fill').style.width = enemy.hp+"px"; }
    function endBattle() { document.getElementById('battle-screen').style.display='none'; updateUI(); }
    function toggleScreen(id) { const s=document.getElementById(id); s.style.display=(s.style.display==='flex'?'none':'flex'); }
</script>
</body>
</html>
