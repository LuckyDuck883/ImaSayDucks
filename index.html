<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuckÃ©mon: Apex Duelist</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { 
            --grass: #78C850; --forest: #45a049; --sand: #F0D060; --water: #6890F0;
            --ui-bg: #f5f5f5; --hp-green: #2ecc71; --hp-red: #e74c3c;
        }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #111; font-family: 'Press Start 2P', cursive; overflow: hidden; }

        /* --- WORLD --- */
        #viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        #world { position: absolute; transition: transform 0.2s linear; }
        .tile { width: 64px; height: 64px; position: absolute; }
        .t-grass { background: var(--grass); border: 1px solid rgba(0,0,0,0.05); }
        .t-forest { background: var(--forest); background-image: radial-gradient(#2D5A27 10%, transparent 10%); background-size: 8px 8px; }
        .t-sand { background: var(--sand); }
        .t-water { background: var(--water); }

        /* --- SPRITES --- */
        .pixel-art {
            width: 4px; height: 4px; background: transparent;
            box-shadow: 8px 4px 0 #000, 12px 4px 0 #000, 16px 4px 0 #000, 4px 8px 0 #000, 8px 8px 0 var(--c), 12px 8px 0 var(--c), 16px 8px 0 var(--c), 20px 8px 0 #000, 4px 12px 0 #000, 8px 12px 0 var(--c), 12px 12px 0 var(--c), 16px 12px 0 var(--c), 20px 12px 0 #e67e22, 8px 16px 0 #000, 12px 16px 0 #000, 16px 16px 0 #000;
            transform: scale(3); position: absolute; transition: 0.2s;
        }
        .evolved { transform: scale(4.5); filter: drop-shadow(0 0 5px var(--c)); }
        .tall-grass-clip { clip-path: inset(0% 0% 35% 0%); }
        #player-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1000; }

        /* --- BATTLE UI --- */
        .screen { position: absolute; inset: 0; z-index: 3000; display: none; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        #battle-screen { background: #98D8D8; flex-direction: column; }
        .battle-info { background: #fff; border: 3px solid #333; padding: 8px; width: 160px; font-size: 7px; border-radius: 0 10px 0 10px; }
        .hp-outer { width: 100%; height: 8px; background: #444; margin-top: 5px; border: 1px solid #000; }
        .hp-inner { height: 100%; background: var(--hp-green); transition: width 0.3s, background 0.3s; }
        #battle-msg { position: absolute; top: 20%; width: 80%; text-align: center; font-size: 8px; color: #000; background: rgba(255,255,255,0.8); padding: 10px; border: 2px solid #000; display: none; }

        /* --- CHAT & HUD --- */
        #chat-box { position: absolute; bottom: 85px; left: 10px; width: 280px; height: 150px; background: rgba(0,0,0,0.8); border: 2px solid #fff; z-index: 2000; display: flex; flex-direction: column; padding: 8px; pointer-events: none; }
        #chat-log { flex-grow: 1; overflow-y: auto; font-size: 7px; color: #fff; line-height: 1.4; }
        #hud { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-between; padding: 10px 20px; z-index: 1500; pointer-events: none; }
        .hud-item { background: #fff; border: 2px solid #000; padding: 5px; font-size: 8px; pointer-events: auto; }

        @keyframes attack-jump { 0%, 100% { transform: scale(6); } 50% { transform: scale(7) translateY(-20px); } }
        .attacking { animation: attack-jump 0.4s; }
    </style>
</head>
<body onload="init()">

<div id="viewport">
    <div id="world"></div>
    <div id="player-container"><div id="p-sprite" class="pixel-art" style="--c:#f1c40f"></div></div>

    <div id="hud">
        <div class="hud-item">ðŸ¥–: <span id="bread">100</span></div>
        <div class="hud-item" onclick="toggleScreen('inv-screen')" style="cursor:pointer;">BAG</div>
        <div class="hud-item">BADGES: <span id="badges">0</span></div>
    </div>

    <div id="chat-box"><div id="chat-log"></div></div>

    <div id="inv-screen" class="screen">
        <div style="background:#fff; padding:20px; border:4px solid #000; width:80%;">
            <h2 style="font-size:10px; text-align:center;">COLLECTION</h2>
            <div id="inventory-slots" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:20px 0;"></div>
            <button class="hud-item" style="width:100%" onclick="toggleScreen('inv-screen')">CLOSE</button>
        </div>
    </div>

    <div id="battle-screen" class="screen">
        <div id="battle-msg">WILD DUCK ATTACKED!</div>
        <div style="flex:1; width:100%; display:flex; justify-content:space-around; align-items:center;">
            <div style="text-align:center;">
                <div class="battle-info">ENEMY<div class="hp-outer"><div id="e-hp-fill" class="hp-inner"></div></div></div>
                <div id="e-sprite-battle" class="pixel-art" style="position:relative; transform:scale(6); margin-top:40px;"></div>
            </div>
            <div style="text-align:center;">
                <div id="p-sprite-battle" class="pixel-art" style="position:relative; transform:scale(6); margin-bottom:40px;"></div>
                <div class="battle-info">YOU<div class="hp-outer"><div id="p-hp-fill" class="hp-inner"></div></div></div>
            </div>
        </div>
        <div id="battle-controls" style="height:150px; width:100%; background:#f8f8f8; border-top:6px solid #333; display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:20px;">
            <button class="hud-item" onclick="playerAttack()">TACKLE</button>
            <button class="hud-item" onclick="playerCatch()">CATCH</button>
        </div>
    </div>
</div>

<script>
    const DUCK_TYPES = [
        { name: "Pebble", color: "#95a5a6", biome: "t-grass", evo: "Gravel-Beak" },
        { name: "Inferno", color: "#e74c3c", biome: "t-forest", evo: "Blaze-Waddler" },
        { name: "Tidal", color: "#3498db", biome: "t-water", evo: "Tsunami-Drake" },
        { name: "Void", color: "#8e44ad", biome: "t-forest", evo: "Eclipse-Lord" },
        { name: "Cosmic", color: "#f1c40f", biome: "any", evo: "Supernova-Duck" }
    ];

    let p = { x: 0, y: 0, bread: 100, inv: [], hp: 100, maxHp: 100, badges: 0 };
    let enemy = null;
    let turn = 'player';
    let rendered = {};

    function init() {
        renderWorld();
        setupInventory();
        setInterval(spawnBotChat, 5000);
        window.addEventListener('keydown', e => {
            if(document.getElementById('battle-screen').style.display==='flex') return;
            const k = e.key.toLowerCase();
            let mx=0, my=0;
            if(k==='w'||k==='arrowup') my=64; if(k==='s'||k==='arrowdown') my=-64;
            if(k==='a'||k==='arrowleft') mx=-64; if(k==='d'||k==='arrowright') mx=64;
            if(mx!==0 || my!==0) move(mx, my
